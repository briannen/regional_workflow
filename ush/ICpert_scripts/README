
1) Check out and build the following version of the SRW App on Hera:

   > git clone -b rrfs_ens_design https://github.com/dtcenter/ufs-srweather-app.git
   > cd ufs-srweather-app
   > ./manage_externals/checkout_externals
   > ./devbuild --machine=hera

   In the following, we let SRW_HOMEDIR denote the directory in which the
   SRW App gets cloned (i.e. "/../ ... /ufs-srweather-app").

2) Generate the 10-member RRFS analog workflow for an ensemble forecast
   WITHOUT stochastic physics and run it up to the "make_ics_..." tasks:

   a) Change location to the directory containing the scripts specific 
      to the DTC Ensemble Design task:

      > cd ${SRW_HOMEDIR}/regional_workflow/ush/ICpert_scripts

   b) In a text editor, open the file "DTC_ensemble_config.sh".  Then
        i) Make sure that "RRFS_do_stoch" is set to "FALSE".  This will
           cause stochastic physics to be turned off in the RRFS analog
           experiment.
       ii) If making a full run (i.e. with all 9 GEFS members and 10 RRFS
           members (where member 01 will be the unperturbed "control"
           member); using the 3km CONUS grid; running for all 13 00Z cycles
           from 20220430 to 20220512; and running all forecasts out to
           the full 36 hours), set "do_test_run" to "FALSE".  If making a
           test run (i.e. with fewer members, on a coarser grid, for fewer
           cycles, and/or with a shorter forecast length), set "do_test_run"
           to "TRUE".
      iii) Set "GEFS_staging_dir" to the directory in which the GEFS
           output (external model) files are staged.

   b) Generate the RRFS workflow:

      > cd ${SRW_HOMEDIR}/regional_workflow/ush/ICpert_scripts
      > ./generate_RRFS_analog_wflow.sh

      This will create an experiment named "RRFS_analog_ICperts_nostoch"
      if "do_test_run" is set to "FALSE", and it will create an experiment
      named "RRFS_analog_ICperts_nostoch_test" if "do_test_run" is set
      to "TRUE".

   c) Change location to the experiment base directory and run the workflow
      up to and including the "make_ics_mem##" and "make_lbcs_mem##" tasks:

      > cd ${SRW_HOMEDIR}/../expt_dirs
      > cd RRFS_analog_ICperts_nostoch[_test]
      > ./launch_FV3LAM_wflow.sh

      Continue issuing the "launch_FV3LAM_wflow.sh" command until the 
      "make_ics_mem${mem}" and "make_lbcs_mem${mem}" tasks are launched,
      where ${mem} is the two-digit index of the member (starting with
      "01").  You can check the status of the workflow by viewing the
      workflow log file "log.launch_FV3LAM_wflow".  In this log file,
      once the status of these tasks turn to "SUBMITTING" or "QUEUED",
      stop calling the workflow launch script.

3) Generate the experiment directories for GEFS members and run their
   workflows.  These are inidividual (non-ensemble) workflows generated
   for each member starting with member 02.  Note that we ignore GEFS
   member 01 because in the RRFS analog, member 01 is a control that will
   remain unperturbed.  The resulting experiments are named "GEFS_mem${mem}"
   (starting with mem="02").  The commands are:

   > cd ${SRW_HOMEDIR}/regional_workflow/ush/ICpert_scripts
   > ./generate_GEFS_member_wflows.sh

   This command will not only generate the GEFS individual member workflows
   but it will also (re)launch them using cron jobs until they complete.
   These workfows include only up to the "make_ics" task and thus should
   complete fairly quickly.  Monitor the status of these workflows until
   they all complete by monitoring the workflow log file.  For example,
   for member 03:

   > cd ${SRW_HOMEDIR}/../expt_dirs
   > cd GEFS_mem03[_test]
   > tail -n 40 log.launch_FV3LAM_wflow

4) Calculate the GEFS ensemble means and perturbations as follows (do
   this only after all the GEFS individual member experiments have
   completed):

   > cd ${SRW_HOMEDIR}/regional_workflow/ush/ICpert_scripts
   > ./calc_add_GEFS_perts_to_RRFS_analog.sh "calc"

   The script "calc_add_GEFS_perts_to_RRFS_analog.sh" can calculate the
   GEFS means and perturbations AND add them to the RRFS analog.  With
   the "calc" argument, it only calculates these (but does not add them
   to the RRFS analog).  Here, we perform the add step separately because
   we only need to perform the calculate step once whereas we have to
   perform the add step twice -- once for the RRFS analog without stochastic
   physics and another with.

5) Add the GEFS perturbations to the RRFS analog (without stochastic
   physics):

   > cd ${SRW_HOMEDIR}/regional_workflow/ush/ICpert_scripts
   > ./calc_add_GEFS_perts_to_RRFS_analog.sh "add"

   This will modify the IC files in the RRFS analog so that they now
   include the GEFS perturbations.

6) Return to the RRFS analog experiment (without stochastic physics) and
   continue by runnning the "run_fcst_mem${mem}" and following tasks:
 
   > cd ${SRW_HOMEDIR}/../expt_dirs
   > cd RRFS_analog_ICperts_nostoch[_test]
   > ./launch_FV3LAM_wflow.sh

   Continue relaunching the workflow until the "run_post_..." tasks are
   launched.

7) Generate the 10-member RRFS analog workflow for an ensemble forecast
   WITH stochastic physics and run it up to the "make_ics_..." tasks.
   These steps are identical to those without stochastic physics except 
   that we now set "RRFS_do_stoch" to "TRUE".  The steps are:

   > cd ${SRW_HOMEDIR}/regional_workflow/ush/ICpert_scripts

   > vi DTC_ensemble_config.sh
     Edit this so that RRFS_do_stoch="TRUE"

   > ./generate_RRFS_analog_wflow.sh

     This will create an experiment named "RRFS_analog_ICperts_stoch" if
     "do_test_run" is set to "FALSE", and it will create an experiment
     named "RRFS_analog_ICperts_stoch_test" if "do_test_run" is set to
     "TRUE".

   > cd ${SRW_HOMEDIR}/../expt_dirs
   > cd RRFS_analog_ICperts_stoch[_test]
   > ./launch_FV3LAM_wflow.sh

     Continue issuing the "launch_FV3LAM_wflow.sh" command until the 
     "make_ics_mem${mem}" and "make_lbcs_mem${mem}" tasks are launched,
     but do not launch the "run_fcst${mem}" tasks.

8) Add the GEFS perturbations to the RRFS analog (with stochastic physics):

   > cd ${SRW_HOMEDIR}/regional_workflow/ush/ICpert_scripts
   > ./calc_add_GEFS_perts_to_RRFS_analog.sh "add"

   This will modify the IC files in the RRFS analog so that they now
   include the GEFS perturbations.  Note that whether these perturbations
   are applied the RRFS analog without stochastic physics or the one with
   is determined by the setting of "RRFS_do_stoch" in the settings file
   "DTC_ensemble_config.sh".  Thus, make sure this remains set to "TRUE".

9) Return to the RRFS analog experiment (with stochastic physics) and
   continue by runnning the "run_fcst_mem${mem}" and following tasks:
 
   > cd ${SRW_HOMEDIR}/../expt_dirs
   > cd RRFS_analog_ICperts_stoch[_test]
   > ./launch_FV3LAM_wflow.sh

   Continue relaunching the workflow until the "run_post_..." tasks are
   launched.

